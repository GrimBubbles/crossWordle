<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dne≈°n√≠ K≈ô√≠≈æovka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* M≈ô√≠≈æka */
        .crossword-grid {
            display: grid;
            gap: 1px;
            background-color: #374151;
            border: 2px solid #374151;
            margin: 0 auto;
            touch-action: manipulation;
        }
        .cell {
            position: relative;
            background-color: white;
            aspect-ratio: 1;
            transition: background-color 0.1s;
        }
        .cell.black { background-color: #1f2937; }
        .cell.tajenka { background-color: #fef08a; } /* ≈Ωlut√° pro tajenku */
        
        /* Zv√Ωraznƒõn√≠ aktivn√≠ho smƒõru/slova */
        .cell.active-highlight { background-color: #e0f2fe !important; } /* Svƒõtle modr√° */
        .cell.tajenka.active-highlight { background-color: #fde047 !important; } /* Tmav≈°√≠ ≈ælut√° */

        /* Inputy */
        .cell input {
            width: 100%; height: 100%;
            text-align: center; font-size: 1.1rem; font-weight: bold;
            text-transform: uppercase; border: none; background: transparent;
            outline: none; padding: 0; margin: 0; color: #111827;
            border-radius: 0; cursor: default;
        }
        /* Focus styl ≈ôe≈°√≠me v JS pomoc√≠ t≈ô√≠dy active-highlight */
        .cell input:focus { background: transparent; } 
        
        /* ƒå√≠sla */
        .cell-number {
            position: absolute; top: 1px; left: 2px;
            font-size: 0.6rem; color: #6b7280; pointer-events: none; line-height: 1;
        }
        
        /* Legenda */
        .clue-item { cursor: pointer; transition: background 0.2s; }
        .clue-item:hover { background-color: #eff6ff; }
        .clue-item.active-clue { background-color: #dbeafe; border-left: 4px solid #2563eb; }
        
        /* Loader */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 600px) { .cell input { font-size: 0.9rem; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col font-sans">

    <main class="flex-grow p-2 md:p-4">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden min-h-[600px]">
            <header class="bg-blue-600 text-white p-4 text-center">
                <h1 class="text-2xl md:text-3xl font-extrabold">Dne≈°n√≠ K≈ô√≠≈æovka</h1>
                <div class="mt-2 inline-block bg-blue-700 bg-opacity-50 px-4 py-1 rounded-full text-sm">
                    T√©ma: <span id="theme-display" class="font-bold">Naƒç√≠t√°n√≠...</span>
                </div>
            </header>

            <div id="loading-state" class="py-20 text-center">
                <div class="loader"></div>
                <p class="text-gray-500">Stahuji k≈ô√≠≈æovku...</p>
            </div>

            <div id="game-content" class="hidden flex flex-col lg:flex-row h-full">
                <!-- Lev√° ƒç√°st: M≈ô√≠≈æka -->
                <div class="flex-1 p-4 flex flex-col items-center justify-start border-r border-gray-100">
                    <div id="grid-container" class="crossword-grid shadow-md mb-6"></div>
                    
                    <div class="flex gap-2 w-full justify-center max-w-sm">
                        <button onclick="checkGame()" class="flex-1 bg-green-600 text-white py-3 rounded shadow font-bold hover:bg-green-700">‚úì Hotovo</button>
                        <button onclick="revealLetter()" class="flex-1 bg-amber-500 text-white py-3 rounded shadow font-bold hover:bg-amber-600">? Pomoc</button>
                    </div>
                    <div id="status-msg" class="mt-4 font-bold h-6 text-center text-lg"></div>
                    <p class="text-xs text-gray-400 mt-2">Tip: Dvojklik na bu≈àku p≈ôepne smƒõr psan√≠.</p>
                </div>

                <!-- Prav√° ƒç√°st: Legenda -->
                <div class="w-full lg:w-96 bg-gray-50 p-4 flex flex-col h-[500px] lg:h-auto overflow-hidden">
                    <h3 class="font-bold text-gray-700 mb-2 border-b">LEGENDA</h3>
                    <div class="overflow-y-auto flex-1 pr-2 space-y-4">
                        
                        <!-- Tajenka Info -->
                        <div class="bg-yellow-100 p-2 rounded border border-yellow-200">
                            <span class="text-xs font-bold text-yellow-800 uppercase">Tajenka (svisle)</span>
                            <div id="tajenka-clue" class="font-bold text-gray-900">...</div>
                        </div>

                        <div>
                            <h4 class="font-bold text-xs text-gray-500 uppercase mb-1">Vodorovnƒõ</h4>
                            <ul id="clues-across" class="space-y-1 text-sm"></ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-xs text-gray-500 uppercase mb-1">Svisle</h4>
                            <ul id="clues-down" class="space-y-1 text-sm"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const JSON_URL = 'data/daily/daily_crossword.json';
        
        let gameState = { 
            grid: [], 
            width: 13, height: 13, 
            words: [] 
        };
        
        // Glob√°ln√≠ stav pro smƒõr psan√≠: 'H' (horizontal) nebo 'V' (vertical)
        let currentDirection = 'H'; 

        async function init() {
            try {
                const res = await fetch(`${JSON_URL}?t=${Date.now()}`);
                if (!res.ok) throw new Error("Nelze naƒç√≠st data");
                const data = await res.json();
                processData(data);
                renderGame();
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('game-content').classList.remove('hidden');
            } catch (e) {
                console.error(e);
                document.getElementById('loading-state').innerHTML = `<p class='text-red-500'>Chyba: ${e.message}</p>`;
            }
        }

        function processData(data) {
            document.getElementById('theme-display').innerText = data.meta.theme;
            document.getElementById('tajenka-clue').innerText = data.tajenka_clue || "Tajenka";
            
            gameState.width = data.meta.width;
            gameState.height = data.meta.height;
            gameState.words = data.words;
            
            if (data.grid) {
                gameState.grid = data.grid.map((row, r) => row.map((char, c) => ({
                    char: char,
                    isBlack: char === '#',
                    isTajenka: isTajenkaCell(r, c, data.tajenka_mask),
                    number: getWordNumberAt(r, c, data.words),
                    // P≈ôedpoƒç√≠t√°me, jak√° slova proch√°z√≠ touto bu≈àkou
                    wordsHere: getWordsAt(r, c, data.words)
                })));
            }
        }

        function isTajenkaCell(r, c, mask) {
            return mask && mask.some(([tr, tc]) => tr === r && tc === c);
        }

        function getWordNumberAt(r, c, words) {
            const w = words.find(w => w.row === r && w.col === c);
            return w ? w.number : null;
        }

        // Zjist√≠, zda je bu≈àka souƒç√°st√≠ vodorovn√©ho a/nebo svisl√©ho slova
        function getWordsAt(r, c, words) {
            let res = { hasH: false, hasV: false };
            words.forEach(w => {
                if (w.direction === 'H' && r === w.row && c >= w.col && c < w.col + w.word.length) res.hasH = true;
                if (w.direction === 'V' && c === w.col && r >= w.row && r < w.row + w.word.length) res.hasV = true;
            });
            return res;
        }

        function renderGame() {
            const container = document.getElementById('grid-container');
            const listAcross = document.getElementById('clues-across');
            const listDown = document.getElementById('clues-down');

            container.style.gridTemplateColumns = `repeat(${gameState.width}, 1fr)`;
            const size = Math.min(35, Math.floor((window.innerWidth - 32) / gameState.width));

            gameState.grid.forEach((row, r) => {
                row.forEach((cell, c) => {
                    const div = document.createElement('div');
                    div.style.width = `${size}px`; div.style.height = `${size}px`;
                    
                    if (cell.isBlack) {
                        div.className = 'cell black';
                    } else {
                        div.className = `cell ${cell.isTajenka ? 'tajenka' : ''}`;
                        if (cell.number) div.innerHTML += `<span class="cell-number">${cell.number}</span>`;
                        
                        const input = document.createElement('input');
                        input.dataset.r = r; input.dataset.c = c;
                        input.dataset.correct = cell.char;
                        input.maxLength = 1;
                        
                        // EVENT LISTENERS PRO PSAN√ç
                        input.addEventListener('keydown', handleKeyInput);
                        input.addEventListener('mousedown', (e) => handleCellClick(e, r, c, cell.wordsHere));
                        input.addEventListener('dblclick', () => toggleDirection());
                        input.addEventListener('focus', () => highlightActiveWord(r, c));

                        div.appendChild(input);
                    }
                    container.appendChild(div);
                });
            });

            // Vykreslen√≠ legendy
            gameState.words.sort((a,b) => a.number - b.number).forEach(w => {
                const li = document.createElement('li');
                li.id = `clue-${w.number}-${w.direction}`; // ID pro highlight
                li.className = 'clue-item p-1 rounded flex gap-2';
                li.innerHTML = `<span class="font-bold text-blue-600 w-5 text-right">${w.number}.</span><span>${w.clue}</span>`;
                
                // Kliknut√≠ na legendu nastav√≠ smƒõr a skoƒç√≠ na slovo
                li.onclick = () => {
                    currentDirection = w.direction;
                    const inp = findCell(w.row, w.col);
                    if(inp) {
                        inp.focus();
                        inp.select();
                    }
                };
                
                if (w.direction === 'H') listAcross.appendChild(li);
                else listDown.appendChild(li);
            });
        }

        // --- Logika Ovl√°d√°n√≠ ---

        function handleCellClick(e, r, c, wordsHere) {
            // Pokud u≈æ m√°me focus, nedƒõl√°me nic (aby fungoval double click),
            // ale pokud klikneme na jinou bu≈àku, zkus√≠me odhadnout smƒõr.
            if (document.activeElement === e.target) return;

            // Chytr√Ω v√Ωbƒõr smƒõru:
            // 1. Pokud bu≈àka pat≈ô√≠ jen do jednoho smƒõru, vybereme ten.
            // 2. Pokud do obou, zachov√°me aktu√°ln√≠, pokud je validn√≠. Jinak preferujeme H.
            if (wordsHere.hasH && !wordsHere.hasV) {
                currentDirection = 'H';
            } else if (wordsHere.hasV && !wordsHere.hasH) {
                currentDirection = 'V';
            } else {
                // Je v obou smƒõrech -> nemƒõn√≠me, pokud to nen√≠ nutn√©
            }
            highlightActiveWord(r, c);
        }

        function toggleDirection() {
            currentDirection = currentDirection === 'H' ? 'V' : 'H';
            // Znovu p≈ôekreslit highlight pro aktu√°lnƒõ focusnut√Ω element
            const active = document.activeElement;
            if (active && active.tagName === 'INPUT') {
                highlightActiveWord(+active.dataset.r, +active.dataset.c);
            }
        }

        function handleKeyInput(e) {
            const r = +e.target.dataset.r;
            const c = +e.target.dataset.c;
            
            // 1. P√≠smena (A-Z)
            if (e.key.match(/^[a-zA-Z√°ƒçƒè√©ƒõ√≠≈à√≥≈ô≈°≈•√∫≈Ø√Ω≈æ√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]$/)) {
                e.preventDefault(); // Zabr√°n√≠me zdvojen√≠ znaku (nƒõkdy)
                e.target.value = e.key.toUpperCase();
                
                // Posun podle smƒõru
                moveFocus(r, c, 1);
            }
            // 2. Backspace (Smazat a zpƒõt)
            else if (e.key === 'Backspace') {
                e.preventDefault();
                e.target.value = '';
                moveFocus(r, c, -1);
            }
            // 3. ≈†ipky (manu√°ln√≠ posun)
            else if (e.key === 'ArrowRight') findCell(r, c + 1)?.focus();
            else if (e.key === 'ArrowLeft') findCell(r, c - 1)?.focus();
            else if (e.key === 'ArrowDown') findCell(r + 1, c)?.focus();
            else if (e.key === 'ArrowUp') findCell(r - 1, c)?.focus();
        }

        function moveFocus(r, c, delta) {
            let nr = r, nc = c;
            
            if (currentDirection === 'H') {
                nc += delta;
            } else {
                nr += delta;
            }

            const nextInput = findCell(nr, nc);
            if (nextInput) {
                nextInput.focus();
                // Volitelnƒõ: vybrat text, aby se dal p≈ôepsat
                // nextInput.select(); 
            }
        }

        function findCell(r, c) {
            return document.querySelector(`input[data-r="${r}"][data-c="${c}"]`);
        }
        
        // Vizu√°ln√≠ vylep≈°en√≠: Zv√Ωrazn√≠ cel√Ω ≈ô√°dek/sloupec podle smƒõru
        function highlightActiveWord(r, c) {
            // Reset v≈°ech highlight≈Ø
            document.querySelectorAll('.active-highlight').forEach(el => el.classList.remove('active-highlight'));
            document.querySelectorAll('.active-clue').forEach(el => el.classList.remove('active-clue'));

            // Najdeme inputy v aktu√°ln√≠m smƒõru
            // Toto je zjednodu≈°en√° vizualizace (sv√≠t√≠ cel√Ω ≈ô√°dek/sloupec), pro komplexn√≠ k≈ô√≠≈æovku staƒç√≠
            const inputs = document.querySelectorAll('input');
            inputs.forEach(inp => {
                const ir = +inp.dataset.r;
                const ic = +inp.dataset.c;
                
                let shouldHighlight = false;
                if (currentDirection === 'H' && ir === r) shouldHighlight = true; // Cel√Ω ≈ô√°dek
                if (currentDirection === 'V' && ic === c) shouldHighlight = true; // Cel√Ω sloupec
                
                // Lep≈°√≠ logika: Highlight jen po ƒçern√© pol√≠ƒçko (skuteƒçn√© slovo)
                // Pro MVP staƒç√≠ cel√Ω ≈ô√°dek/sloupec, pom√°h√° to orientaci
                if (shouldHighlight) {
                    inp.parentElement.classList.add('active-highlight');
                }
            });
            
            // Zv√Ωraznƒõn√≠ legendy (pokud tref√≠me zaƒç√°tek slova)
            // Tohle je slo≈æitƒõj≈°√≠ trefit p≈ôesnƒõ, proto≈æe na jedn√© bu≈àce m≈Ø≈æe b√Ωt st≈ôed slova.
            // Ale m≈Ø≈æeme naj√≠t slovo, kter√© proch√°z√≠ touto bu≈àkou v aktu√°ln√≠m smƒõru.
            const activeWord = gameState.words.find(w => {
                if (w.direction !== currentDirection) return false;
                if (currentDirection === 'H') return w.row === r && c >= w.col && c < w.col + w.word.length;
                if (currentDirection === 'V') return w.col === c && r >= w.row && r < w.row + w.word.length;
                return false;
            });

            if (activeWord) {
                const clueEl = document.getElementById(`clue-${activeWord.number}-${activeWord.direction}`);
                if (clueEl) {
                    clueEl.classList.add('active-clue');
                    clueEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        function checkGame() {
            let err = 0, empty = 0;
            document.querySelectorAll('input').forEach(i => {
                const val = i.value.toUpperCase();
                i.parentElement.classList.remove('bg-red-100', 'bg-green-100');
                if(!val) empty++;
                else if(val !== i.dataset.correct) {
                    err++; i.parentElement.classList.add('bg-red-100');
                    i.style.color = 'red';
                } else {
                    i.parentElement.classList.add('bg-green-100');
                    i.style.color = 'green';
                }
            });
            const status = document.getElementById('status-msg');
            if(err===0 && empty===0) {
                status.innerText = "üéâ Perfektn√≠! V≈°e spr√°vnƒõ.";
                status.className = "mt-4 font-bold h-6 text-center text-green-600 animate-bounce";
            } else {
                status.innerText = `Chyb: ${err}, Pr√°zdn√Ωch: ${empty}`;
                status.className = "mt-4 font-bold h-6 text-center text-red-600";
            }
        }

        function revealLetter() {
            const bad = Array.from(document.querySelectorAll('input')).filter(i => i.value.toUpperCase() !== i.dataset.correct);
            if(bad.length) {
                const el = bad[Math.floor(Math.random()*bad.length)];
                el.value = el.dataset.correct;
                el.style.color = 'blue';
            }
        }

        init();
    </script>
</body>
</html>
